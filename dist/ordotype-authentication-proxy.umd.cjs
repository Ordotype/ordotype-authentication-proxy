(function(a){typeof define=="function"&&define.amd?define(a):a()})(function(){"use strict";var k=Object.defineProperty;var T=(a,i,l)=>i in a?k(a,i,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[i]=l;var u=(a,i,l)=>T(a,typeof i!="symbol"?i+"":i,l);const a={LOGOUT:"memberstack.logout",GET_APP:"memberstack.getApp",LOGIN:"memberstack.login"};function i(){window._msConfig||(window._msConfig={preventLogin:!0}),window.$memberstackDom=new Proxy(window.$memberstackDom,{get(n,e){const t=n[e];return typeof t=="function"?async function(...o){var s;if(console.log(`Method ${e} called with arguments: ${JSON.stringify(o)}`),e==="logout"){const r=new Event(a.LOGOUT,{bubbles:!1,cancelable:!1});return document.dispatchEvent(r),!1}if(e==="getApp"){const r=new Event(a.GET_APP,{bubbles:!1,cancelable:!1});document.dispatchEvent(r)}if(e==="loginMemberEmailPassword"){const r=new CustomEvent(a.LOGIN,{bubbles:!1,cancelable:!1,detail:o[0]});return document.dispatchEvent(r),((s=window._msConfig)==null?void 0:s.preventLogin)&&!1}return t.apply(n,o)}:t}})}function l(){const n="_ga_7T2LX34911",e=document.cookie.split("; ");for(const t of e){const[o,s]=t.split("=");if(o===n)return s}throw new Error("Device Id cookie not found")}function d(){return!!localStorage.getItem("_ms-mid")}const h="https://staging-api.ordotype.fr/v1.0.0";class m extends Error{constructor(t,o=500){super(t);u(this,"status");this.name="AuthError",this.status=o,Error.captureStackTrace&&Error.captureStackTrace(this,m)}}class w extends Error{constructor(t,o,s){super(t);u(this,"data");u(this,"type");this.name="TwoFactorRequiredError",this.data=o,this.type=s}}class S{constructor(){u(this,"headers");const e="pk_sb_e80d8429a51c2ceb0530",t=window.localStorage.getItem("ms_session_id"),o=l();this.headers={"X-Api-Key":e,"X-Session-Id":t??void 0,"X-Device-Id":o??void 0}}async request(e,t,o="GET",s=null,r={}){const f=`${h}/${t}/${e}`,b={"Content-Type":"application/json",...this.headers,...r},v={method:o,headers:b,...s&&{body:JSON.stringify(s)}};try{const c=await fetch(f,v);if(!c.ok)throw new m(c.statusText,c.status);return await c.json()}catch(c){throw console.error("API Request Failed:",c),c}}async validateSessionStatus(){try{if(!d())return null;const e=localStorage.getItem("_ms-mid");return await this.request("validate-session-status","auth","POST",null,{Authorization:`Bearer ${e}`})}catch(e){throw console.error("Session validation failed:",e),e}}async logout(){try{if(!d())return;const e=localStorage.getItem("_ms-mid");await this.request("logout","auth","POST",null,{Authorization:`Bearer ${e}`}),localStorage.removeItem("_ms-mid")}catch(e){throw console.error("Session logout failed:",e),e}}async login(e){const t=await this.request("login","auth","POST",e,{});if(p(t))throw new w("2fa required",t.data,t.type);return t}getCookie(e){const t=document.cookie.match(new RegExp(`(^| )${e}=([^;]+)`));return t?decodeURIComponent(t[2]):null}setCookie(e,t,o){const s=new Date;s.setTime(s.getTime()+o),document.cookie=`${e}=${encodeURIComponent(t)}; expires=${s.toUTCString()}; path=/`}async throttle(e,t,o){const s=this.getCookie(t),r=Date.now();if(s&&r-parseInt(s,10)<o)return console.log(`Skipping execution of ${t}: Throttled.`),null;console.log(`Executing ${t}...`);const f=await e();return this.setCookie(t,r.toString(),o),f}validateSessionStatusThrottled(){return localStorage.getItem("_ms-mid")?this.throttle(()=>this.validateSessionStatus(),"lastSessionValidation",3*60*1e3):Promise.resolve(null)}}function p(n){return"data"in n&&typeof n.data=="object"&&"type"in n.data}i();const g=new S;document.addEventListener(a.GET_APP,async()=>{if(console.log("getApp"),!!d())try{if(await g.validateSessionStatus()===!1){await window.$memberstackDom.logout();return}}catch(n){if(n instanceof m){(n.status===401||n.status===403)&&await window.$memberstackDom.logout();return}}}),document.addEventListener(a.LOGOUT,async()=>{console.log("logout"),await g.logout(),localStorage.removeItem("_ms-mid"),localStorage.removeItem("_ms_mem"),window.location.href="/"}),document.addEventListener(a.LOGIN,async n=>{if(console.log("login"),d()){console.log("Member is already logged in.");return}try{const{detail:e}=n,t=await g.login({email:e.email,password:e.password});localStorage.setItem("_ms-mid",t.data.tokens.accessToken),localStorage.setItem("_ms-mem",JSON.stringify(t.data.member)),window.location.href=t.data.redirect}catch(e){if(e instanceof w){const t="_ms-2fa-session",o=JSON.stringify({data:e.data,type:e.type});sessionStorage.setItem(t,o),window.location.href=void 0;return}throw e}})});
